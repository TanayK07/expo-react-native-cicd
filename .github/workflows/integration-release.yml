name: Integration Tests (Release — EAS Builds)

on:
  workflow_dispatch:
    inputs:
      run_eas_builds:
        type: boolean
        description: "Actually run EAS builds (requires EXPO_TOKEN)"
        default: false
  release:
    types: [created]

jobs:
  eas-build:
    name: "EAS Build: ${{ matrix.name }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { name: "yarn-eas-development",    index: 0, fixture: "yarn-app" }
          - { name: "yarn-eas-production-apk", index: 1, fixture: "yarn-app" }
          - { name: "yarn-eas-production",     index: 2, fixture: "yarn-app" }
          - { name: "npm-eas-development",     index: 3, fixture: "npm-app"  }
          - { name: "npm-eas-production-apk",  index: 4, fixture: "npm-app"  }
          - { name: "npm-eas-production",      index: 5, fixture: "npm-app"  }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install webapp dependencies
        working-directory: webapp
        run: yarn install --frozen-lockfile

      - name: Install integration-tests dependencies
        working-directory: integration-tests
        run: npm ci

      - name: Install fixture app dependencies (${{ matrix.fixture }})
        working-directory: integration-tests/fixtures/${{ matrix.fixture }}
        run: |
          if [ "${{ matrix.fixture }}" = "yarn-app" ]; then
            yarn install --frozen-lockfile
          else
            npm ci
          fi

      - name: Install EAS CLI
        run: npm install -g eas-cli@latest

      - name: Run integration test — ${{ matrix.name }}
        working-directory: integration-tests
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.run_eas_builds }}" = "true" ] || [ "${{ github.event_name }}" = "release" ]; then
            npx ts-node scripts/run-single.ts \
              --matrix-file configs/eas-matrix.json \
              --config-index ${{ matrix.index }} \
              --fixture-dir fixtures/${{ matrix.fixture }} \
              --include-build-job \
              --verbose
          else
            echo "EAS builds skipped (set run_eas_builds=true to enable)"
            npx ts-node scripts/run-single.ts \
              --matrix-file configs/eas-matrix.json \
              --config-index ${{ matrix.index }} \
              --fixture-dir fixtures/${{ matrix.fixture }} \
              --skip-build \
              --verbose
          fi
